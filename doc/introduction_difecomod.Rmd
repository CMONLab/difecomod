---
title: "difecomod: Differential Co-occurrence Analysis for Ecological Modules"
author: "Jacopo Iacovacci"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Differential Co-occurrence Analysis for Ecological Modules}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 8,
  fig.align = "center"
)
```

## Introduction

The `difecomod` package implements differential co-occurrence analysis methodology for detecting ecosystem blocks or modules that change between host conditions in microbiome data. This approach is particularly useful for understanding how microbial community interactions are altered by disease states, treatments, or environmental changes.

### Methodology Overview

Given the modularity of microbial network interactions, we hypothesize that different ecosystem blocks or modules coexist within the microbiota and that changes in the host environment (e.g., disease conditions) might favor certain blocks of interacting species over others.

The methodology consists of several key steps:

1.  **Data Processing**: Convert relative abundance data to binary occurrence matrices
2.  **Co-occurrence Calculation**: Compute frequencies of taxa co-occurrence in each condition\
3.  **Statistical Testing**: Use null random and permutation models for co-occurrences to assess significance
4.  **Network Construction**: Build microbial networks of significant differential co-occurrences
5.  **Higher-Order Interactions**: Analyze three-taxa co-occurrences in data

## Installation

```{r eval=FALSE}
# Install devtools if not already installed
if (!require("devtools")) install.packages("devtools")

# Install difecomod from GitHub
devtools::install_github("CMONLab/difecomod")

```

```{r setup}
library(difecomod)
library(SummarizedExperiment)
library(ggplot2)
library(pheatmap)
library(igraph)
library(tictoc)
set.seed(1234)  # For reproducible examples
```

## Basic Usage

### Using Gupta Data Set as Example Data

For demonstration, we'll use microbiome data from faecal samples in two host conditions: colorectal cancer (CRC) versus healthy individuals:

```{r load_data}
# Load JAMS processed data from package
# The data file is located in the package's extdata directory
data_path <- system.file("extdata", "CRC_cohorts_JAMS_processed", "Gupta.RData",
                         package = "difecomod")

# Check if data file exists
if (data_path == "" || !file.exists(data_path)) {
  stop("Data file not found. Please ensure the package was installed correctly with data files.")
}

load(data_path)

# Extract abundance table and metadata
count_table <- assay(expvec$LKT, "BaseCounts");
pheno <- as.data.frame(colData(expvec$LKT));
pheno$condition <- pheno$disease;

# Calculate total read counts
tot_counts <- colSums(count_table);

# Calculate percentage tables
abundance_table <- scale(count_table, center = FALSE, scale = tot_counts);

# Visualize core microbiota
core_plot <- core_visualization(  
  abundance_table,
  prevalence_threshold = 1,
  min_prevalence = 0.1
);

print(core_plot)

# Extract core microbiota taxa
abundance_table <- core_extraction(
  abundance_table,
  prevalence_threshold = 1,
  min_prevalence = 0.1
);

# Separate abundance tables for healthy and disease 
samples_healthy <- rownames(pheno[pheno$condition=='healthy',]);
samples_disease <- rownames(pheno[pheno$condition=='CRC',]);

abundance_healthy <- abundance_table[, samples_healthy];
abundance_disease <- abundance_table[, samples_disease];

# Display data summaries
cat("Healthy condition - Samples:", ncol(abundance_healthy), "Taxa:", nrow(abundance_healthy), "\n")
cat("Disease condition - Samples:", ncol(abundance_disease), "Taxa:", nrow(abundance_disease), "\n")


```

## Step-by-Step Differential Co-occurrence Analysis

For more control over the analysis process, you can run each step individually:

### Step 1: Convert to Occurrence Matrices

```{r occurrence_matrices}
# Convert abundance to binary occurrence matrices
occ_healthy <- calculate_cooccurrence_matrix(
  abundance_healthy,
  detection_threshold = 0.01
)

occ_disease <- calculate_cooccurrence_matrix(
  abundance_disease,
  detection_threshold = 0.01
)

cat("Occurrence matrices created:\n")

```

### Step 2: Calculate Co-occurrence Frequencies

```{r cooccurrence_calc}
# Extract co-occurrence frequencies for each condition
cooccur_healthy <- extract_cooccurrence_list(occ_healthy)
cooccur_disease <- extract_cooccurrence_list(occ_disease)

# Calculate delta co-occurrence
delta_cooccur <- cooccur_healthy$O - cooccur_disease$O

cat("Co-occurrence statistics:\n")
cat("Number of taxa pairs:", length(delta_cooccur), "\n")
cat("Delta co-occurrence (Healthy - Disease) frequency range:", 
    sprintf("[%.4f, %.4f]", min(delta_cooccur), max(delta_cooccur)), "\n")
```

### Step 3: Statistical Testing

```{r statistical_testing}
tic()
# Random delta co-occurrence model - tests against chance co-occurrence
cat("Running random delta co-occurrence model...\n")
random_model <- delta_cooccurrence_random_model(
  occ_healthy, occ_disease, 
  n = 8000
)
toc()
tic()
# Permutation delta co-occurrence model - tests against random sample grouping  
cat("Running permutation delta co-occurrence model...\n")
perm_model <- delta_cooccurrence_permutation_model(
  occ_healthy, occ_disease,
  n = 8000
)
toc()
# Calculate statistical thresholds
upper_lower_rand <- compute_random_model_thresholds(random_model$Values, n_sigma = 1)
upper_lower_perm <- compute_permutation_model_thresholds(perm_model$Values, conf = 0.05)
```

### Step 4: Network Construction

```{r network_construction}
# Construct differential co-occurrence network
network_matrix <- construct_network_delta(
  delta_I = delta_cooccur,
  links_I = cooccur_healthy$I, 
  nodes_I = colnames(occ_healthy), #common_taxa,
  stat_thr_rand = upper_lower_rand,
  stat_thr_perm = upper_lower_perm
)

print(sort(colSums(abs(network_matrix))))

cat("Network construction results:\n")
if (length(network_matrix) > 1) {
  n_significant <- sum(abs(network_matrix) > 0) / 2  # Symmetric matrix
  n_positive <- sum(network_matrix > 0) / 2
  n_negative <- sum(network_matrix < 0) / 2
  
  cat("Significant interactions:", n_significant, "\n")
  cat("Over-represented in Healthy VS Disease:", n_positive, "\n") 
  cat("Under-represented in Healthy VS Disease:", n_negative, "\n")
  cat("Connected taxa:", nrow(network_matrix), "\n")
  
  network_plot <- plot_cooccurrence_network(network_matrix, title = "Differential Co-occurrence Network")
  print(network_plot)
  # To export in pdf
  # ggsave(sprintf("differential_cooccurrence_network.pdf"), plot = network_plot, device = NULL,
  #       path = "./", scale = 0.9, width = 20, height = 16, dpi = 300,
  #       limitsize = TRUE);
  
} else {
  cat("No significant interactions found.\n")
}
```

## Abundance Data Visualization

Even when differential co-occurrence patterns are subtle, we can visualize the abundance patterns:

```{r heatmap_viz, fig.cap="Abundance heatmap showing taxa patterns across samples with condition annotations."}
#  Select taxa in Differential Co-occurrence Network
dcn_taxa <- names(rowSums(abs(network_matrix))[rowSums(abs(network_matrix))>0]);

# Centered-log ratio transformation of core count abundances
clr_table <- clr_transformation(
  count_table[rownames(abundance_table), ],
  zero_imputation_method = "GBM"
);

# Standardization of clr-table
z <- t(scale(t(clr_table), center = TRUE, scale = TRUE))

# Extract covariate data
col_covariates <- data.frame(pheno[, c("condition", "gender")])
col_covariates$gender <- factor(col_covariates$gender, levels=c("male", "female"))
col_covariates$condition <- factor(col_covariates$condition, levels=c("healthy", "CRC"))

heatmap_plot <- microbiota_heatmap(z, col_covariates)

# To export in pdf
# ggsave(sprintf("TEST_differential_cooccurrence_heatmap.pdf"), plot = heatmap_plot, device = NULL,
#       path = "./", scale = 0.9, width = 8, height = 8, dpi = 300,
#       limitsize = TRUE);

```

## Higher-Order Interactions Analysis

The package supports analysis of three-taxa co-occurrences:

```{r hoi_analysis}
# Extract Higher-Order Interactions (HOI) Analysis
# ================================================
# Higher-order interactions capture complex relationships between three taxa
# that co-occur together more or less frequently than expected.

cat("Analyzing higher-order interactions...\n\n")

# Extract all triplet interactions from both conditions
hoi_healthy <- extract_hoi_list(occ_healthy)
hoi_disease <- extract_hoi_list(occ_disease)

# Calculate delta-HOI for all possible triplets
delta_hoi_all <- hoi_healthy$O - hoi_disease$O

cat("Number of all possible triplet interactions:", length(hoi_healthy$O), "\n")

# Identify network triangles (3-node cliques)
# ===================================================
# Look for triangles in the co-occurrence network (motifs where 
# three taxa form a connected cluster) with edges having consistent signs).

# Extract network triangles with consistent edge values 
cat("Identifying network triangles with consistent edge signs...\n")

triangle_results <- extract_network_triangles(
  adj_matrix = network_matrix,
  filter_sign = TRUE
)

#INetF <- graph_from_adjacency_matrix(abs(network_matrix), mode="undirected");
#triangles_nodes <- count_triangles(INetF);
#triangles_list <- t(matrix(triangles(INetF), nrow = 3));
#triangles_list <- t(apply(triangles_list, 1, sort));
  
triangles_list <- triangle_results$triangles_list
triangle_taxa_indices <- triangle_results$triangle_taxa_indices
triangle_taxa <- triangle_results$triangle_taxa

table(c(triangles_list[,1],triangles_list[,2],triangles_list[,3]))

cat("Network triangles identified:", nrow(triangles_list), "\n")

# # Get unique taxa involved in triangles
cat("Unique taxa in triangles:", length(triangle_taxa), "\n")
cat("Triangle taxa:\n")
print(head(triangle_taxa, 10))
cat("  ... (showing first 10)\n\n")

# Extract HOI specifically for network triangles with remapped indices
hoi_healthy_tri <- extract_hoi_sublist(occ_healthy, sub_list = triangles_list)
hoi_disease_tri <- extract_hoi_sublist(occ_disease, sub_list = triangles_list)
delta_hoi_triangles <- hoi_healthy_tri$O - hoi_disease_tri$O

cat("Differential HOI statistics for triangles (Healthy - Disease):\n")
cat("  Mean change:", round(mean(delta_hoi_triangles), 3), "\n")
cat("  Range:", round(min(delta_hoi_triangles), 3), "to", 
    round(max(delta_hoi_triangles), 3), "\n\n")

# Generate null models for statistical testing
# =====================================================
#     Random Model: Shuffles feature columns independently within each condition
#     Tests whether differential HOI exceeds what's expected if taxa associations
#     were random but marginal frequencies were preserved.

tic()
cat("Computing random model null distribution...\n")
hoi_random <- delta_hoi_random_model(
  X1occ = occ_healthy, 
  X2occ = occ_disease,
  n = 8000, 
  n_sigma = 1,
  triangle_list = triangles_list,
  values = TRUE
)
toc()

#     Permutation Model: Permutes sample labels between conditions
#     Tests whether differential HOI exceeds what's expected if condition
#     assignment were arbitrary.
tic()
cat("Computing permutation model null distribution...\n")
hoi_perm <- delta_hoi_permutation_model(
  X1occ = occ_healthy,
  X2occ = occ_disease,
  n = 8000,
  conf = 0.05,
  triangle_list = triangles_list,
  values = TRUE
)
toc()
```

# Visualize Higher-Order Interactions

```{r hoi_visualization}
# This creates a matrix showing which triplets are significantly enriched/depleted
# based on both null models. The diagram visualizes the overlap between
# statistical tests and highlights robust HOI changes.

cat("Constructing HOI diagram...\n")

# Extract threshold statistics from null models
# The construct_HOI_diagram function requires thresholds in list format
stat_thr_rand <- list(
  lower = hoi_random$Stats$low_thr,
  upper = hoi_random$Stats$up_thr
)

stat_thr_perm <- list(
  lower = hoi_perm$Stats$low_thr,
  upper = hoi_perm$Stats$up_thr
)

# Construct the HOI diagram
hoi_diagram_raw <- construct_hoi_diagram(
  delta_I = delta_hoi_triangles,
  links_I = hoi_healthy_tri$I,
  nodes_I = triangle_taxa,
  stat_thr_rand = stat_thr_rand,
  stat_thr_perm = stat_thr_perm
)

hoi_diagram <- validate_hoi_diagram(
  hoi_diagram = hoi_diagram_raw,
  network_matrix = network_matrix
)

# Visualize if significant triplets exist
if (!is.null(dim(hoi_diagram)) && is.matrix(hoi_diagram)) {
  cat("HOI diagram created with", nrow(hoi_diagram), "taxa in", 
      ncol(hoi_diagram), "significant triplets\n")
  cat("Generating visualization...\n\n")
  
  # Create heatmap visualization
  # Red = depleted in healthy (enriched in disease)
  # Green = enriched in healthy (depleted in disease)
  heatmap_hoi <- pheatmap::pheatmap(
    hoi_diagram,
    cluster_rows = FALSE,
    cluster_cols = FALSE,
    show_colnames = FALSE,
    color = c("red", "black", "black", "green"),
    breaks = c(-1, -0.5, 0, 0.5, 1),
    main = "Higher-Order Differential Co-occurrences",
    fontsize = 10
  )

  # # To export in pdf
  # ggsave(sprintf("TEST_differential_cooccurrence_hoi.pdf"), plot = heatmap_hoi, device = NULL,
  #        path = "./", scale = 0.9, width = 8, height = 8, dpi = 300, limitsize = TRUE);

  cat("HOI diagram visualization displayed above.\n")
  cat("  - Green: HOI triplets more frequent in healthy condition\n")
  cat("  - Red: HOI triplets more frequent in disease condition\n")
  cat("  - Black: Non-significant changes\n\n")
  
} else if (identical(hoi_diagram, 0)) {
  # Function returned 0 (no significant HOI)
  cat("No significant HOI changes detected.\n")
  cat("This may indicate:\n")
  cat("  - Similar interaction patterns between conditions\n")
  cat("  - Insufficient statistical power (increase n permutations)\n")
  cat("  - Very few network triangles in the data\n\n")
  
} else {
  cat("HOI diagram could not be created.\n")
}

# HOI Summary Statistics
# ======================
cat("\nSummary of significant HOI changes:\n")

# Count significant triplets by each model
sig_random <- which(
  delta_hoi_triangles > hoi_random$Stats$up_thr | 
  delta_hoi_triangles < hoi_random$Stats$low_thr
)

sig_perm <- which(
  delta_hoi_triangles > hoi_perm$Stats$up_thr | 
  delta_hoi_triangles < hoi_perm$Stats$low_thr
)

sig_both <- intersect(sig_random, sig_perm)

cat("  Significant by random model:", length(sig_random), "triplets\n")
cat("  Significant by permutation model:", length(sig_perm), "triplets\n")
cat("  Significant by both models:", length(sig_both), "triplets\n")

if (length(sig_both) > 0) {
  cat("    - Enriched in healthy:", 
      sum(delta_hoi_triangles[sig_both] > 0), "triplets\n")
  cat("    - Enriched in disease:", 
      sum(delta_hoi_triangles[sig_both] < 0), "triplets\n")
} else {
  cat("  No triplets passed both statistical tests.\n")
}

cat("\nHOI visualization section completed.\n")

```

## Real Data Considerations

When working with real microbiome data:

1.  **Sample Size**: Ensure adequate sample sizes (\>20 samples per condition recommended)

2.  **Taxa Filtering**: Use appropriate prevalence thresholds to extract core genera (10% recommended)

3.  **Abundance Threshold**: Set meaningful detection thresholds (0.01-0.1% relative abundance)

4.  **Permutation/Reshuffling Number**: Use sufficient number of permutations/reshufflings for robust statistical inference (\>=5000)

5.  **Biological Interpretation**: Validate significant interactions using biological knowledge and literature

## Session Information

```{r sessionInfo}
sessionInfo()
```
